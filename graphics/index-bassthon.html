<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Hello World</title>
    </head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="js/pixi.min.js"></script>
    <script src="js/pixi-filters.js"></script>
    <script src="js/pixi-patch.js"></script>


    <body>
        <script type="text/javascript">
        //Create a Pixi Application
        let app = new PIXI.Application({
            width: 1280, 
            height: 720,                       
            antialias: true, 
            transparent: true, 
            resolution: 1
        });

        document.body.appendChild(app.view);
        
        load()

        function load() {
            setup();
        }

        var thonVideo;
        var bassVideo;

        var stingerCooldownTime = 0;

        var currentBassCooldownTime;
        var currentThonCooldownTime;

        function setup() {
            nodecg.log.info("P I N G — Overlay System — BassThon™ Addon");

            // Add the 'keydown' event listener to our document
            document.addEventListener('keydown', onKeyDown);

            thonVideo = document.createElement("video");
            thonVideo.autoplay = false;
            thonVideo.preload = "auto";
            thonVideo.src = "media/THON OVERLAY TEST.webm";
            thonVideo.paused = true;
            thonVideo.load();

            thonVideoTex = PIXI.Texture.fromVideo(thonVideo);
            thonVideoSprite = new PIXI.Sprite(thonVideoTex);

            bassVideo = document.createElement("video");
            bassVideo.autoplay = false;
            bassVideo.preload = "auto";
            bassVideo.src = "media/bass OVERLAY TEST.webm";
            bassVideo.paused = true;
            bassVideo.load();

            bassVideoTex = PIXI.Texture.fromVideo(bassVideo);
            bassVideoSprite = new PIXI.Sprite(bassVideoTex);

            app.stage.addChild(thonVideoSprite);
            app.stage.addChild(bassVideoSprite);
            
            currentBassCooldownTime = stingerCooldownTime;
            currentThonCooldownTime = stingerCooldownTime;

            const stingerCooldownTimeReplicant = nodecg.Replicant(
                "bassthonStingerCooldownTime",
                {defaultValue: 60}
            );

            stingerCooldownTimeReplicant.on("change", (newValue, oldValue) => {
                if (newValue) {
                    stingerCooldownTime = currentBassCooldownTime = currentThonCooldownTime = newValue;
                }
            });

            nodecg.listenFor("cooldownAction", (value, ack) => {
                if (value.action == "reset") {
                    currentBassCooldownTime = currentThonCooldownTime = stingerCooldownTime;
                }
                else if (value.action == "burn") {
                    currentBassCooldownTime = currentThonCooldownTime = 0;
                }
            });

            nodecg.listenFor("sendTeamStinger", (value, ack) => {
                sendTeamStinger(value.teamName)
            });

            nodecg.listenFor("physicalButtonStateChanged", (value, ack) => {
                if (value.buttonState == true) {
                    switch (value.buttonName) {
                        case "Button1":
                            sendTeamStinger("bass");
                            break;

                        case "Button2":
                            sendTeamStinger("thon");
                            break;
                    }
                }
            });

            app.ticker.add(update);
        }

        function update(delta) {
            if (currentBassCooldownTime > 0) {
                currentBassCooldownTime -= app.ticker.elapsedMS / 1000.;
            }

            if (currentThonCooldownTime > 0) {
                currentThonCooldownTime -= app.ticker.elapsedMS / 1000.;
            }
        }

        function onKeyDown(key) {
            /*if (key.keyCode == 37) {
                showScreen(0);
            }
            else if (key.keyCode == 40) {
                showScreen(1);
            }*/
        }

        function sendTeamStinger(teamName) {
            if (teamName == "bass") {
                showScreen(0);
            }
            else if (teamName == "thon") {
                showScreen(1);
            }
            else if (teamName == "both") {
                showScreen(0);
                showScreen(1);
            }
        }

        function showScreen(screenId) {
            if (screenId == 0) {
                if (currentBassCooldownTime <= 0) {
                    if (bassVideo.paused) {
                        bassVideo.currentTime = 0;
                        bassVideo.play();
                        currentBassCooldownTime = stingerCooldownTime;
                    }
                }
            }
            else if (screenId == 1) {
                if (currentThonCooldownTime <= 0) {
                    if (thonVideo.paused) {
                        thonVideo.currentTime = 0;
                        thonVideo.play();
                        currentThonCooldownTime = stingerCooldownTime;
                    }
                }
            }
        }
        </script>
    </body>
</html>


<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello World</title>
</head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="js/pixi.min.js"></script>
    <script src="js/type.min.js"></script>
    <script src="text-scrolling.js"></script>
    <script src="container-scrolling.js"></script>
    <script src="container-sliding.js"></script>
    <script src="container-fading.js"></script>
    <script src="ping-header.js"></script>
<body>
    <script type="text/javascript">
    //Create a Pixi Application
    let app = new PIXI.Application({
        width: 1280, 
        height: 720,                       
        antialias: true, 
        transparent: true, 
        resolution: 1
    });

    var followersText;

    FONT_STYLE = {fontFamily : "brownie-regular", fontSize: 40, fill : 0xDBF2FF, align : 'left', letterSpacing: -5}

    document.body.appendChild(app.view);
    
    load()

    function load() {
        var typeLoader = new type.Loader();
  
        typeLoader.add('brownie-light', 'fonts/BROWNIElight.otf');
        typeLoader.add('brownie-regular', 'fonts/BROWNIEregular.otf');
  
        typeLoader.load();
        typeLoader.once('loadComplete', setup);
    }

    function setup() {
        nodecg.log.info('P I N G â€” Overlay System');

        headerWidget = new PingHeader();

        app.stage.addChild(headerWidget);

        nodecg.listenFor("sendAlert", (value, ack) => {
            console.log(value);
            headerWidget.createAlert(value.title, value.content);
        });
        
        followersText = new PIXI.Text(
            "Loading followers...",
            FONT_STYLE
            );

        txt = new ScrollingContainer(followersText, 0, 0, 727, 79, 20);

        blur_effect = new PIXI.filters.BlurFilter()
        blur_effect.blur = 8;

        $.ajax({
            type: "GET",
            url: "https://api.twitch.tv/helix/users/follows?to_id=27497503",// 38503140",
            dataType: 'json',
            headers:  {
                'Client-ID': "ulv1v7toq6fwfps9pmcrnlg6r6t7ex",
            },
            error: function(response) {  },
            success: function(response) {
                var lastFollowerId = response.data[0].from_id;
                getFollowerName(lastFollowerId);
            }
        });
  
        const currentGameReplicant = nodecg.Replicant('currentGame');
  
        var currentGameTextWidget = new PIXI.Text(`${currentGameReplicant.value}`, FONT_STYLE);
  
        currentGameReplicant.on('change', (newValue, oldValue) => {
            currentGameTextWidget.text = `${newValue}`;
        });
  
        fadeObj = new FadingContainer(200, 200, currentGameTextWidget);

        currentGameTextWidget_blured = Object.create(currentGameTextWidget)
        currentGameTextWidget_blured.filters = [blur_effect];

        fadeObj.addChild(currentGameTextWidget_blured);

        nodecg.listenFor("forceShowCurrentGame", (value, ack) => {
            if (value == true) {
                fadeObj.fadeIn();
            }
            else {
                fadeObj.fadeOut();
            }
        });

        nowPlayingTitleWidget = new PIXI.Text("Now Playing", FONT_STYLE)
        nowPlayingHeaderInfo = new HeaderInfo("NowPlaying", currentGameTextWidget, nowPlayingTitleWidget, 3);

        followersTitleWidget = new PIXI.Text("Last Followers", FONT_STYLE)
        followersHeaderInfo = new HeaderInfo("LastFollowers", txt, followersTitleWidget, 3);

        headerWidget.addInfo(nowPlayingHeaderInfo);
        headerWidget.addInfo(followersHeaderInfo);


        app.ticker.add(update);
    }

    function getFollowerName(followerId) {
        var lastFollowerName = null;

        $.ajax({
        type: "GET",
        url: "https://api.twitch.tv/helix/users?id=" + followerId,
        dataType: 'json',  
        headers:  {  
            'Client-ID': "ulv1v7toq6fwfps9pmcrnlg6r6t7ex",
        },
        error: function(response) {  },
        success: function(response) {
            lastFollowerName = response.data[0].display_name;
            followersText.text = lastFollowerName;
            //txt.regenerateContainers();
        }
        });
    }

    function update(delta) {

    }

    </script>
</body>
</html>